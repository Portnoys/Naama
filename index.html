<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מחקר נעמה קרניאל</title>
  <style>
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      margin:0; padding:20px;
      background:#0b0f14; color:#eef2f6;
    }
    .card{
      max-width:1400px;
      margin:0 auto;
      background:#111823; border:1px solid #1b2433;
      border-radius:16px; padding:20px;
    }
    h1{ margin:0 0 6px; font-size:2rem; }
    .muted{ color:#a9b4c6; font-size:1.5rem; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .center-row{ justify-content:center; width:100%; }
    .field{ flex:1 1 200px; }
    .field label{ display:block; font-weight:600; margin:10px 0 6px; }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #243044; background:#0e141d; color:#eef2f6;
    }

    .btn{
      appearance:none; border:0; padding:12px 18px;
      border-radius:12px; background:#4b8bff; color:#fff;
      font-weight:700; cursor:pointer;
    }
    .btn[disabled]{ background:#33415c; cursor:not-allowed; }

    .hr{ border-top:1px dashed #243044; margin:16px 0; }

    video{
      width:75%;
      margin: 0 auto;
      border-radius:12px;
      border:1px solid #1b2433;
      background:#000;
      aspect-ratio:16/9;
      display:block;
      cursor:pointer; /* כדי שיהיה ברור שאפשר ללחוץ לניגון */
    }

    .vas-wrap{ max-width:420px; margin:0 auto; }
    .vas-wrap label{ font-size:1.05rem; }
    #ratingVal{ font-size:1.35rem; font-weight:800; color:#ffd166; }

    input[type="range"]{
      width:100%; height:6px; border-radius:8px; -webkit-appearance:none; appearance:none; direction:ltr;
      background: linear-gradient(to right,#e74c3c 0%,#e74c3c 33.333%,#f4c430 33.333%,#f4c430 66.666%,#2ecc71 66.666%,#2ecc71 100%);
      outline:none;
    }
    input[type="range"]::-webkit-slider-runnable-track{ height:6px; border-radius:8px; background:transparent; }
    input[type="range"]::-moz-range-track{ height:6px; border-radius:8px; background:transparent; }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
      background:#fff; border:2px solid #4b8bff; margin-top:-6px; cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #4b8bff; cursor:pointer; }

    .vas-labels{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:6px; font-size:0.95rem; color:#c9d4e6; text-align:center; }

    @media (max-width:720px){
      .vas-wrap{ max-width:92vw; }
      video{ width:100%; }
    }
  </style>
</head>
<body>

  <!-- דף שער: לוגו + PID -->
  <div id="coverScreen" class="card">
    <div style="display:flex;justify-content:center;margin-bottom:18px;">
      <img src="OccTherapyLogo_HEBENG_NEG.png" alt="לוגו אוניברסיטת תל אביב"
           style="max-width:900px;width:50%;height:auto;" />
    </div>

    <h1>לפני שנתחיל</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem;">
      אנא הזינו מספר נבדק (חובה) ואז לחצו התחלה.
    </p>

    <div class="row" style="margin-top:10px;">
      <div class="field" style="min-width:260px;max-width:520px;">
       <input id="participantCover" type="text" placeholder="מספר נבדק" />
      </div>
      <div>
        <button id="startFromCoverBtn" class="btn">התחלה</button>
      </div>
      <div id="pidMsg" class="muted" style="font-size:1.1rem;"></div>
    </div>
  </div>

  <!-- מסך בחירת מצגת (יופיע רק אחרי שלב הבחינה) -->
  <div id="introChoiceScreen" class="card" style="display:none;">
    <h1>לפני השלב הבא</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem;">
      עכשיו בחרו איזו מצגת להפעיל. הסרטון יוצג במסך מלא..
    </p>

    <div class="row center-row" style="margin-top:18px;">
      <button id="startIntroBtn1" class="btn">מצגת 1</button>
      <button id="startIntroBtn2" class="btn">מצגת 2</button>
    </div>
  </div>

  <!-- המסך הראשי -->
  <div id="mainCard" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;align-items:baseline;">
      <h1 id="title">צפייה בסרטון</h1>
    </div>

    <p class="muted" style="margin-top:8px">
      יש לצפות בסרטון עד הסוף. לאחר השליחה עוברים אוטומטית לסרטון הבא.
      <br/>
      ניגון מתבצע בלחיצה על הווידאו.
    </p>

    <div>
      <!-- כל הסרטונים בלי קול -->
      <video id="vid" controls playsinline preload="auto" muted></video>
    </div>

    <div class="hr"></div>

    <div class="vas-wrap">
      <div class="row" style="justify-content:center;">
        <div class="field" style="min-width:220px;">
          <label for="ratingRange">VAS ציון: <span id="ratingVal">5.0</span></label>
          <input id="ratingRange" type="range" min="0" max="10" step="0.1" value="5.0" />
          <div class="vas-labels" aria-hidden="true">
            <span>טוב</span><span>בינוני</span><span>גרוע</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px;">
      <button id="submitBtn" class="btn" disabled>שליחת ציון</button>
    </div>

    <div id="msg" style="margin-top:14px"></div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ===== Supabase =====
  const SUPABASE_URL = 'https://dbintxdkurajdgimcdeb.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaW50eGRrdXJhamRnaW1jZGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc1NTAsImV4cCI6MjA3NDEwMzU1MH0.usRUg5lTw96BaEydMV9wl8vtuZ3-e0MZA1UUMgh5YaA';
  const RATINGS_TABLE = 'ratings';

  // ===== בסיס נתיב לקבצים החדשים (של הבחינה) =====
  const BASE_URL = 'https://portnoys.github.io/Naama/';
  const EXAM_EXT = '.MP4';

  // ===== מצגות =====
  const INTRO_VIDEO_1 = 'https://portnoys.github.io/Naama/Lecture_research.mp4';
  const INTRO_VIDEO_2 = 'https://portnoys.github.io/Naama/Lecture_balance.mp4';

  // ===== למידה =====
  const LEARNING_VIDEOS = [
    { url: 'https://portnoys.github.io/Naama/סרט 1 למידה 2.8.mp4',  score: 2.8 },
    { url: 'https://portnoys.github.io/Naama/סרט 2 למידה 9.9.mp4',  score: 9.9 },
    { url: 'https://portnoys.github.io/Naama/סרט 3 למידה  8.1.mp4', score: 8.1 },
    { url: 'https://portnoys.github.io/Naama/סרט 4 למידה 4.7.mp4',  score: 4.7 },
    { url: 'https://portnoys.github.io/Naama/סרט 5 למידה 1.3.mp4',  score: 1.3 },
    { url: 'https://portnoys.github.io/Naama/סרט 6 למידה 4.4.mp4',  score: 4.4 }
  ];

  // ===== תרגול עם משוב =====
  const FEEDBACK_VIDEOS = [
    { url: 'https://portnoys.github.io/Naama/אימון 1 עם משוב 8.0.mp4',  score: 8.0 },
    { url: 'https://portnoys.github.io/Naama/אימון 2 עם משוב 1.2.mp4',  score: 1.2 },
    { url: 'https://portnoys.github.io/Naama/אימון 3 עם משוב 4.9.mp4',  score: 4.9 },
    { url: 'https://portnoys.github.io/Naama/אימון 4 עם משוב 9.9.mp4',  score: 9.9 },
    { url: 'https://portnoys.github.io/Naama/אימון 5 עם משוב 2.5.mp4',  score: 2.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 6 עם משוב 6.1.mp4',  score: 6.1 },
    { url: 'https://portnoys.github.io/Naama/אימון 7 עם משוב 4.5.mp4',  score: 4.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 8 עם משוב 9.4.mp4',  score: 9.4 },
    { url: 'https://portnoys.github.io/Naama/אימון 9 עם משוב 1.6.mp4',  score: 1.6 },
    { url: 'https://portnoys.github.io/Naama/אימון 10 עם משוב 8.5.mp4', score: 8.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 11 עם משוב 5.5.mp4', score: 5.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 12 עם משוב 2.8.mp4', score: 2.8 }
  ];

  // ===== שלב בחינה (26 סרטים) =====
  const EXAM_FILES_IN_ORDER = [
    '27_8.6','25_4.4','65_8.1','27_8.4','79_1.5','74_8.1','65_1.4','22_9.8','35_1.6','67_4.7',
    '16_4.8','55_6.6','77_9.6','70_1.4','70_4.4','32_1.2','16_5.9','66_5.7','72_4.4','70_4.3',
    '50_1.6','18_4.9','67_4.8','35_1.4','74_7.6','32_2.0'
  ];

  const EXAM_VIDEOS = EXAM_FILES_IN_ORDER.map(name => ({
    url: `${BASE_URL}${name}${EXAM_EXT}`,
    file: name
  }));

  // ===== ניסוי ראשי =====
  const MAIN_VIDEOS = [
    'https://portnoys.github.io/Naama/7.mp4',
    'https://portnoys.github.io/Naama/6.mp4',
    'https://portnoys.github.io/Naama/5.mp4',
    'https://portnoys.github.io/Naama/4.mp4'
  ];

  // ===== הגבלת זמן סרטון =====
  const MAX_SECONDS_PER_VIDEO = 10;

  // ===== DOM =====
  const coverScreen       = document.getElementById('coverScreen');
  const introChoiceScreen = document.getElementById('introChoiceScreen');
  const mainCard          = document.getElementById('mainCard');

  const participantCover  = document.getElementById('participantCover');
  const startFromCoverBtn = document.getElementById('startFromCoverBtn');
  const pidMsg            = document.getElementById('pidMsg');

  const startIntroBtn1    = document.getElementById('startIntroBtn1');
  const startIntroBtn2    = document.getElementById('startIntroBtn2');

  const titleEl           = document.getElementById('title');
  const vid               = document.getElementById('vid');

  const ratingRange       = document.getElementById('ratingRange');
  const ratingVal         = document.getElementById('ratingVal');
  const submitBtn         = document.getElementById('submitBtn');
  const msg               = document.getElementById('msg');

  // reset
  participantCover.value = '';
  pidMsg.textContent = '';

  // תמיד בלי קול
  vid.muted = true;
  vid.volume = 0;

  // ===== מצב =====
  let participantId = '';

  // cover -> learning -> feedback -> exam -> introChoice(+intro playback) -> main
  let phase = 'cover'; // 'learning' | 'feedback' | 'exam' | 'intro' | 'main'
  let learnIndex = 0;
  let feedbackIndex = 0;
  let examIndex = 0;
  let mainIndex = 0;

  let videoCompleted = false;
  let feedbackReveal = false;
  let vasChanged = false;

  // ===== חיתוך ב-10 שניות =====
  let cutoffSeconds = MAX_SECONDS_PER_VIDEO;
  let cutoffArmed = false;

  function disarmCutoff(){
    cutoffArmed = false;
  }

  function armCutoff(){
    // אם הסרטון קצר מ-10 שניות – הוא יסתיים טבעית קודם
    // ואם ארוך יותר – נחתוך ב-10.0
    const dur = Number(vid.duration);
    if (Number.isFinite(dur) && dur > 0) {
      cutoffSeconds = Math.min(MAX_SECONDS_PER_VIDEO, dur);
    } else {
      cutoffSeconds = MAX_SECONDS_PER_VIDEO;
    }
    cutoffArmed = true;
  }

  function forceEndAtCutoff(){
    if (!cutoffArmed) return;
    if (vid.currentTime >= cutoffSeconds - 0.03) { // מרווח קטן כדי לא "לפספס"
      cutoffArmed = false;
      try { vid.pause(); } catch(e){}
      // ניישר לזמן חיתוך כדי שלא יהיה "עוד רגע" של וידאו
      try { vid.currentTime = cutoffSeconds; } catch(e){}
      handleVideoEnd('cutoff');
    }
  }

  function showOnly(screen){
    coverScreen.style.display = (screen === 'cover') ? '' : 'none';
    introChoiceScreen.style.display = (screen === 'introChoice') ? '' : 'none';
    mainCard.style.display = (screen === 'main') ? '' : 'none';
  }

  function setRating(val){
    const v = Math.min(10, Math.max(0, Number(val)));
    ratingRange.value = v.toFixed(1);
    ratingVal.textContent = v.toFixed(1);
    let color;
    if (v <= 3.333) color = '#e74c3c';
    else if (v <= 6.666) color = '#f4c430';
    else color = '#2ecc71';
    ratingVal.style.color = color;
  }

  function resetStepUI(){
    videoCompleted = false;
    submitBtn.disabled = true;
    msg.innerHTML = '';
    feedbackReveal = false;
    vasChanged = false;
    disarmCutoff();
  }

  function setTitles(){
    if (phase === 'learning') titleEl.textContent = `סרטון למידה ${learnIndex+1} מתוך ${LEARNING_VIDEOS.length}`;
    if (phase === 'feedback') titleEl.textContent = `אימון עם משוב ${feedbackIndex+1} מתוך ${FEEDBACK_VIDEOS.length}`;
    if (phase === 'exam') titleEl.textContent = `שלב בחינה ${examIndex+1} מתוך ${EXAM_VIDEOS.length}`;
    if (phase === 'intro') titleEl.textContent = `מצגת`;
    if (phase === 'main') titleEl.textContent = `צפייה בסרטון ${mainIndex+1}`;
  }

  function loadCurrentVideo(){
    resetStepUI();
    showOnly('main');
    setTitles();

    // תמיד בלי קול
    vid.muted = true;
    vid.volume = 0;

    if (phase === 'learning') {
      const vobj = LEARNING_VIDEOS[learnIndex];
      vid.src = vobj.url;

      // למידה: ללא דירוג
      ratingRange.disabled = true;
      submitBtn.textContent = 'המשך';

      setRating(vobj.score); // רק להצגה/אחידות (לא ניתן לשינוי)

    } else if (phase === 'feedback') {
      const vobj = FEEDBACK_VIDEOS[feedbackIndex];
      vid.src = vobj.url;

      // תרגול עם משוב: צריך לדרג
      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'המשך';

    } else if (phase === 'exam') {
      const vobj = EXAM_VIDEOS[examIndex];
      vid.src = vobj.url;

      // בחינה: צריך לדרג, אין משוב
      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'שליחת ציון והמשך';

    } else if (phase === 'intro') {
      // מצגת: בלי דירוג/שליחה
      ratingRange.disabled = true;
      submitBtn.disabled = true;
      submitBtn.textContent = 'המשך';

    } else { // main
      vid.src = MAIN_VIDEOS[mainIndex];

      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'שליחת ציון';
    }
  }

  // כדי לאפשר "אחרי סרטון משוב" רק אם הזיזו את ה-VAS
  ['input','change'].forEach(ev => {
    ratingRange.addEventListener(ev, () => {
      if (phase === 'feedback' || phase === 'exam' || phase === 'main') {
        setRating(ratingRange.value);
      }
      if (phase === 'feedback' && !vasChanged) {
        vasChanged = true;
        if (videoCompleted && !feedbackReveal) submitBtn.disabled = false;
      }
    });
  });

  // התחלה מדף שער -> למידה
  startFromCoverBtn.addEventListener('click', () => {
    const v = (participantCover.value || '').trim();
    if (!v) {
      pidMsg.textContent = 'נא להזין מספר נבדק';
      return;
    }
    participantId = v;
    pidMsg.textContent = 'נשמר ✔';

    phase = 'learning';
    learnIndex = 0;
    loadCurrentVideo();
  });

  // ניגון ע"י לחיצה על הווידאו עצמו
  vid.addEventListener('click', async () => {
    if (!participantId) return;

    // תמיד בלי קול
    vid.muted = true;
    vid.volume = 0;

    // התחלה מחדש
    try { vid.currentTime = 0; } catch(e){}

    try {
      await vid.play();
    } catch(e) {
      try { vid.play().catch(() => {}); } catch(_) {}
    }
  });

  // שמירה ל-Supabase
  async function supabaseInsert(row) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${RATINGS_TABLE}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(row)
      });
      if (!res.ok) return;
    } catch {}
  }

  function handleVideoEnd(source){
    // source: 'natural' | 'cutoff'
    if (videoCompleted) return; // הגנה מפני ירי כפול
    videoCompleted = true;

    if (phase === 'intro') {
      if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      }
      // אחרי המצגת -> ניסוי ראשי
      phase = 'main';
      mainIndex = 0;
      loadCurrentVideo();
      return;
    }

    if (phase === 'feedback') {
      // תאפשרי המשך רק אחרי שהוזז VAS
      if (vasChanged && !feedbackReveal) submitBtn.disabled = false;
    } else {
      // learning / exam / main
      submitBtn.disabled = false;
    }
  }

  // כשהווידאו נגמר טבעית
  vid.addEventListener('ended', () => {
    disarmCutoff();
    handleVideoEnd('natural');
  });

  // כשהמטא-דאטה נטענת (יש duration) – נקים חיתוך ל-10 שניות
  vid.addEventListener('loadedmetadata', () => {
    // תמיד בלי קול
    vid.muted = true;
    vid.volume = 0;
    armCutoff();
  });

  // בזמן ניגון – נבדוק אם עברנו 10 שניות ונחתוך
  vid.addEventListener('timeupdate', () => {
    forceEndAtCutoff();
  });

  // בחירת מצגת (רק אחרי שלב הבחינה)
  function startIntroWithVideo(introUrl) {
    if (!participantId) return;

    phase = 'intro';
    showOnly('main');
    resetStepUI();
    setTitles();

    ratingRange.disabled = true;
    submitBtn.disabled = true;

    vid.src = introUrl;

    // תמיד בלי קול
    vid.muted = true;
    vid.volume = 0;

    try { vid.preload = 'auto'; } catch(e){}
    try { vid.currentTime = 0; } catch(e){}

    const p = vid.play();
    if (p && p.catch) p.catch(() => {});

    if (vid.requestFullscreen) vid.requestFullscreen().catch(()=>{});
    else if (vid.webkitRequestFullscreen) vid.webkitRequestFullscreen();
    else if (vid.msRequestFullscreen) vid.msRequestFullscreen();
  }

  startIntroBtn1.addEventListener('click', () => startIntroWithVideo(INTRO_VIDEO_1));
  startIntroBtn2.addEventListener('click', () => startIntroWithVideo(INTRO_VIDEO_2));

  // כפתור שליחה/המשך
  submitBtn.addEventListener('click', async () => {
    if (!videoCompleted) return;
    if (!participantId) return;

    // ===== למידה =====
    if (phase === 'learning') {
      submitBtn.disabled = true;

      if (learnIndex < LEARNING_VIDEOS.length - 1) {
        learnIndex++;
        loadCurrentVideo();
      } else {
        phase = 'feedback';
        feedbackIndex = 0;
        loadCurrentVideo();
      }
      return;
    }

    // ===== תרגול עם משוב =====
    if (phase === 'feedback') {
      const vobj = FEEDBACK_VIDEOS[feedbackIndex];

      if (!feedbackReveal) {
        submitBtn.disabled = true;

        const payload = {
          participant_id: participantId,
          video_url: vobj.url,
          rating: Number(ratingRange.value),
          user_agent: navigator.userAgent.slice(0, 500),
          meta: {
            pageHref: location.href,
            video_index: feedbackIndex + 1,
            phase: 'feedback',
            true_score: vobj.score,
            endedOnce: true,
            // תיעוד האם נחתך ב-10 שניות או נגמר טבעית:
            end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
          }
        };

        await supabaseInsert(payload);

        ratingRange.disabled = true;
        feedbackReveal = true;

        msg.innerHTML =
          `<div style="font-size:2rem;font-weight:700;margin-top:10px;">
             הציון האמיתי של סרטון זה הוא: ${vobj.score.toFixed(1)}
           </div>`;

        submitBtn.textContent =
          (feedbackIndex < FEEDBACK_VIDEOS.length - 1)
            ? 'המשך לסרטון הבא'
            : 'המשך לשלב הבחינה';

        submitBtn.disabled = false;
        return;
      }

      // אחרי הצגת המשוב -> עוברים הלאה
      submitBtn.disabled = true;
      msg.innerHTML = '';
      ratingRange.disabled = false;
      submitBtn.textContent = 'המשך';

      if (feedbackIndex < FEEDBACK_VIDEOS.length - 1) {
        feedbackIndex++;
        loadCurrentVideo();
      } else {
        // מעבר לשלב בחינה
        phase = 'exam';
        examIndex = 0;
        loadCurrentVideo();
      }
      return;
    }

    // ===== שלב בחינה (26) =====
    if (phase === 'exam') {
      submitBtn.disabled = true;

      const vobj = EXAM_VIDEOS[examIndex];

      const payload = {
        participant_id: participantId,
        video_url: vobj.url,
        rating: Number(ratingRange.value),
        user_agent: navigator.userAgent.slice(0, 500),
        meta: {
          pageHref: location.href,
          video_index: examIndex + 1,
          phase: 'exam',
          file_name: vobj.file,
          endedOnce: true,
          end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
        }
      };

      await supabaseInsert(payload);

      if (examIndex < EXAM_VIDEOS.length - 1) {
        examIndex++;
        loadCurrentVideo();
      } else {
        // אחרי הבחינה -> בחירת מצגת
        showOnly('introChoice');
      }
      return;
    }

    // ===== ניסוי ראשי =====
    if (phase === 'main') {
      submitBtn.disabled = true;

      const payload = {
        participant_id: participantId,
        video_url: MAIN_VIDEOS[mainIndex],
        rating: Number(ratingRange.value),
        user_agent: navigator.userAgent.slice(0, 500),
        meta: {
          pageHref: location.href,
          video_index: mainIndex + 1,
          phase: 'main',
          endedOnce: true,
          end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
        }
      };

      await supabaseInsert(payload);

      if (mainIndex < MAIN_VIDEOS.length - 1) {
        mainIndex++;
        loadCurrentVideo();
      } else {
        submitBtn.disabled = true;
        msg.textContent = 'תודה! סיימת את כל הסרטונים.';
      }
      return;
    }
  });

  // init
  setRating(5.0);
  showOnly('cover');
});
</script>
</body>
</html>
