<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מחקר נעמה קרניאל</title>
  <style>
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      margin:0; padding:20px;
      background:#0b0f14; color:#eef2f6;
    }
    .card{
      max-width:1400px;
      margin:0 auto;
      background:#111823; border:1px solid #1b2433;
      border-radius:16px; padding:20px;
    }
    h1{ margin:0 0 6px; font-size:2rem; }
    .muted{ color:#a9b4c6; font-size:1.5rem; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .center-row{ justify-content:center; width:100%; }
    .field{ flex:1 1 200px; }
    .field label{ display:block; font-weight:600; margin:10px 0 6px; }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #243044; background:#0e141d; color:#eef2f6;
    }

    .btn{
      appearance:none; border:0; padding:12px 18px;
      border-radius:12px; background:#4b8bff; color:#fff;
      font-weight:700; cursor:pointer;
    }
    .btn[disabled]{ background:#33415c; cursor:not-allowed; }

    .hr{ border-top:1px dashed #243044; margin:16px 0; }

    video{
      width:75%;
      margin: 0 auto;
      border-radius:12px;
      border:1px solid #1b2433;
      background:#000;
      aspect-ratio:16/9;
      display:block;
      cursor:pointer;
    }

    .vas-wrap{ max-width:520px; margin:0 auto; }
    .vas-wrap label{ font-size:1.05rem; }
    #ratingVal{ font-size:1.35rem; font-weight:800; color:#ffd166; }

    input[type="range"]{
      width:100%; height:6px; border-radius:8px; -webkit-appearance:none; appearance:none; direction:ltr;
      background: linear-gradient(to right,#e74c3c 0%,#e74c3c 33.333%,#f4c430 33.333%,#f4c430 66.666%,#2ecc71 66.666%,#2ecc71 100%);
      outline:none;
    }
    input[type="range"]::-webkit-slider-runnable-track{ height:6px; border-radius:8px; background:transparent; }
    input[type="range"]::-moz-range-track{ height:6px; border-radius:8px; background:transparent; }

    /* סמן VAS גדול יותר */
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:28px; height:28px; border-radius:50%;
      background:#fff; border:3px solid #4b8bff;
      margin-top:-11px; cursor:pointer;
      box-shadow:0 2px 10px rgba(0,0,0,0.35);
    }
    input[type="range"]::-moz-range-thumb{
      width:28px; height:28px; border-radius:50%;
      background:#fff; border:3px solid #4b8bff; cursor:pointer;
      box-shadow:0 2px 10px rgba(0,0,0,0.35);
    }

    .vas-labels{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:6px; font-size:0.95rem; color:#c9d4e6; text-align:center; }

    @media (max-width:720px){
      .vas-wrap{ max-width:92vw; }
      video{ width:100%; }
    }
  </style>
</head>
<body>

  <!-- דף שער: לוגו + PID -->
  <div id="coverScreen" class="card">
    <div style="display:flex;justify-content:center;margin-bottom:18px;">
      <img src="OccTherapyLogo_HEBENG_NEG.png" alt="לוגו אוניברסיטת תל אביב"
           style="max-width:900px;width:30%;height:auto;" />
    </div>

    <h1>לפני שנתחיל</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem;">
      אנא הזינו מספר נבדק ואז לחצו התחלה.
    </p>

    <div class="row" style="margin-top:10px;">
      <div class="field" style="min-width:260px;max-width:520px;">
       <input id="participantCover" type="text" placeholder="מספר נבדק" />
      </div>
      <div>
        <button id="startFromCoverBtn" class="btn">התחלה</button>
      </div>
      <div id="pidMsg" class="muted" style="font-size:1.1rem;"></div>
    </div>
  </div>

  <!-- מסך הוראות -->
  <div id="instructionsScreen" class="card" style="display:none;">
    <div style="display:flex;justify-content:center;margin-bottom:12px;">
      <img src="OccTherapyLogo_HEBENG_NEG.png" alt="לוגו אוניברסיטת תל אביב"
           style="max-width:900px;width:20%;height:auto;" />
    </div>

    <h1>שלום,</h1>

    <div class="muted" style="margin-top:8px;font-size:1.6rem; line-height:1.6;">
      במהלך השעה הקרובה תעשו היכרות עם מערכת למדידת שווי משקל שמופעלת על ידי שטיחון לחץ.<br>

      הציון להערכת שיווי המשקל נע בין 1, שיווי משקל גרוע מאוד ועד 10, שיווי משקל מצויין.
      האומדן נקבע על פי מידת התנועה של מרכז הלחץ. ככל שיש תנועה רבה יותר, שיווי המשקל פחות טוב.
      אורך אבחון של שיווי משקל הוא 10 שניות.<br>

      תעברו שלושה שלבים:
      <ol style="margin:10px 22px 0; padding:0; color:#c9d4e6;">
        <li style="margin:8px 0;">
          שלב הצגת המערכת שבו תצפו ב-6 סרטונים, כאשר הציון יוצג בתחתית הסרטון.
        </li>
        <li style="margin:8px 0;">
          שלב תרגול, שבו תצפו ב-12 סרטונים ואז תתבקשו להזיז את הסמן על סקאלה בין 1 ל10 כדי לדרג את הביצועים.
          לאחר שתתנו דירוג, יתגלה הציון האמיתי.
        </li>
        <li style="margin:8px 0;">
          שלב בדיקה שבו תצפו ב26 סרטונים, אותם תתבקשו לדרג (לא יתגלה לכם הציון האמיתי)
        </li>
      </ol>

      <br>
      לאחר מכן תצפו במצגת של כ-13 דקות. בסיום המצגת תתבקשו לדרג 26 סרטונים נוספים.<br>

      יש לקחת בחשבון שכל נבדק צולם מספר פעמים בזמנים שונים, כך שיתכנו ביצועים שונים לאותו הנבדק.<br>

      נבקשכם שלא לקחת הפסקות ארוכות בזמן דירוג הסרטונים ולא לסגור את הדפדפן. במידה ויש צורך בהפסקה, השתדלו לקחת אותה לפני או אחרי המצגת.<br>

      לאורך כל הדרך ניתן להתקשר לנעמה לקבל הנחיות 0544435433<br>
      תודה.
    </div>

    <div class="row center-row" style="margin-top:18px;">
      <button id="continueFromInstructionsBtn" class="btn">המשך</button>
    </div>
  </div>

  <!-- מסך בחירת מצגת (יופיע רק אחרי שלב הבחינה הראשון) -->
  <div id="introChoiceScreen" class="card" style="display:none;">
    <h1>לפני השלב הבא</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem;">
      עכשיו בחרו איזו מצגת להפעיל. הסרטון יוצג במסך מלא..
    </p>

    <div class="row center-row" style="margin-top:18px;">
      <button id="startIntroBtn1" class="btn">מצגת 1</button>
      <button id="startIntroBtn2" class="btn">מצגת 2</button>
    </div>
  </div>

  <!-- ✅ מסך בדיקה אחרי המצגת: האם צפית עד הסוף? -->
  <div id="postIntroCheckScreen" class="card" style="display:none;">
    <div style="display:flex;justify-content:center;margin-bottom:18px;">
      <img src="OccTherapyLogo_HEBENG_NEG.png" alt="לוגו אוניברסיטת תל אביב"
           style="max-width:900px;width:20%;height:auto;" />
    </div>

    <h1>שאלה קצרה</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem; line-height:1.5;">
      האם צפית בכל המצגת מתחילתה ועד סופה?
    </p>

    <div class="row center-row" style="margin-top:18px;">
      <button id="introWatchedYesBtn" class="btn">כן</button>
      <button id="introWatchedNoBtn" class="btn">לא — צפייה חוזרת</button>
    </div>

    <p class="muted" style="margin-top:14px;font-size:1.2rem;">
      אם לחצת "לא", תוכלו לבחור שוב איזו מצגת להפעיל.
    </p>
  </div>

  <!-- ✅ מסך מעבר אחרי המצגת (שקופית כמו עם הלוגו) -->
  <div id="postIntroBreakScreen" class="card" style="display:none;">
    <div style="display:flex;justify-content:center;margin-bottom:18px;">
      <img src="OccTherapyLogo_HEBENG_NEG.png" alt="לוגו אוניברסיטת תל אביב"
           style="max-width:900px;width:20%;height:auto;" />
    </div>

    <h1>לפני השלב האחרון</h1>
    <p class="muted" style="margin-top:8px;font-size:2.2rem; line-height:1.5;">
      כעת תבצעו בדיקה נוספת ואחרונה של 26 סרטים.<br>
      זה הזמן לעשות הפסקה קצרה, להתרענן אם יש צורך
    </p>

    <div class="row center-row" style="margin-top:18px;">
      <button id="continueToFinalExamBtn" class="btn">המשך</button>
    </div>
  </div>

  <!-- המסך הראשי -->
  <div id="mainCard" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;align-items:baseline;">
      <h1 id="title">צפייה בסרטון</h1>
    </div>

    <!-- טקסט דינמי לפי שלב -->
    <p id="instructionsText" class="muted" style="margin-top:8px"></p>

    <div>
      <video id="vid" controls playsinline preload="auto" muted></video>
    </div>

    <div class="hr"></div>

    <div class="vas-wrap">
      <div class="row" style="justify-content:center;">
        <div class="field" style="min-width:220px;">
          <label for="ratingRange"> ציון: <span id="ratingVal">5.0</span></label>
          <input id="ratingRange" type="range" min="0" max="10" step="0.1" value="5.0" />
          <div class="vas-labels" aria-hidden="true">
            <span>טוב</span><span>בינוני</span><span>גרוע</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:18px; align-items:center; justify-content:center;">
      <button id="submitBtn" class="btn" disabled>שליחת ציון</button>
      <div id="msg" style="margin-right:20px; font-size:1.6rem; font-weight:700;"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {

  const GOOGLE_SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycby7jWvSrZuJyFYiAETn5u25RFflgcLl9ruzrjjxv-jFAXj6r47leI1KwcbVAbEb_3vI1g/exec';

  async function sheetInsert(row) {
    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(row)
      });
    } catch {}
  }

  // ===== טקסטים לפי שלב =====
  const LEARNING_TEXT =
    'אנא צפו בסרטון עד הסוף. ציון הבדיקה מופיע בתחתית.';

  const FEEDBACK_TEXT =
    'אנא צפו בסרטון עד הסוף. לאחר מכן, הזיזו את הסמן על סקאלה שמתחת לסרטון בין 1 ל10 כדי לדרג את הביצועים. לאחר שתלחצו על "המשך", יוצג הציון האמיתי.';

  const EXAM_TEXT =
    'אנא צפו בסרטון עד הסוף. לאחר מכן, הזיזו את הסמן על סקאלה שמתחת לסרטון בין 1 ל10 כדי לדרג את הביצועים. לאחר שתלחצו על "המשך" תועברו לסרטון הבא (ללא גילוי הציון האמיתי).';

  // ===== בסיס נתיב לקבצים החדשים (של הבחינות) =====
  const BASE_URL = 'https://portnoys.github.io/Naama/';
  const EXAM_EXT = '.mp4';

  // ===== מצגות =====
  const INTRO_VIDEO_1 = 'https://portnoys.github.io/Naama/Lecture_research.mp4';
  const INTRO_VIDEO_2 = 'https://portnoys.github.io/Naama/Lecture_balance.mp4';

  // ===== למידה =====
  const LEARNING_VIDEOS = [
    { url: 'https://portnoys.github.io/Naama/סרט 1 למידה 2.8.mp4',  score: 2.8 },
    { url: 'https://portnoys.github.io/Naama/סרט 2 למידה 9.9.mp4',  score: 9.9 },
    { url: 'https://portnoys.github.io/Naama/סרט 3 למידה  8.1.mp4', score: 8.1 },
    { url: 'https://portnoys.github.io/Naama/סרט 4 למידה 4.7.mp4',  score: 4.7 },
    { url: 'https://portnoys.github.io/Naama/סרט 5 למידה 1.3.mp4',  score: 1.3 },
    { url: 'https://portnoys.github.io/Naama/סרט 6 למידה 4.4.mp4',  score: 4.4 }
  ];

  // ===== תרגול עם משוב =====
  const FEEDBACK_VIDEOS = [
    { url: 'https://portnoys.github.io/Naama/אימון 1 עם משוב 8.0.mp4',  score: 8.0 },
    { url: 'https://portnoys.github.io/Naama/אימון 2 עם משוב 1.2.mp4',  score: 1.2 },
    { url: 'https://portnoys.github.io/Naama/אימון 3 עם משוב 4.9.mp4',  score: 4.9 },
    { url: 'https://portnoys.github.io/Naama/אימון 4 עם משוב 9.9.mp4',  score: 9.9 },
    { url: 'https://portnoys.github.io/Naama/אימון 5 עם משוב 2.5.mp4',  score: 2.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 6 עם משוב 6.1.mp4',  score: 6.1 },
    { url: 'https://portnoys.github.io/Naama/אימון 7 עם משוב 4.5.mp4',  score: 4.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 8 עם משוב 9.4.mp4',  score: 9.4 },
    { url: 'https://portnoys.github.io/Naama/אימון 9 עם משוב 1.6.mp4',  score: 1.6 },
    { url: 'https://portnoys.github.io/Naama/אימון 10 עם משוב 8.5.mp4', score: 8.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 11 עם משוב 5.5.mp4', score: 5.5 },
    { url: 'https://portnoys.github.io/Naama/אימון 12 עם משוב 2.8.mp4', score: 2.8 }
  ];
// ===== שלב בחינה ראשון (26 סרטים) =====
const EXAM_FILES_IN_ORDER = [
  '67_4.7',
  '25_4.4',
  '65_8.1',
  '35_1.6',
  '79_1.5',
  '74_8.1',
  '65_1.4',
  '27_8.6',
  '22_9.8',
  '27_8.4',
  '16_4.8',
  '55_6.6',
  '77_9.6',
  '70_1.4',
  '70_4.4',
  '32_1.2',
  '16_5.9',
  '66_5.7',
  '72_4.8',
  '70_4.3',
  '50_1.6',
  '18_4.6',
  '67_4.8',
  '35_1.4',
  '74_7.6',
  '32_2.0'
];

  const EXAM_VIDEOS = EXAM_FILES_IN_ORDER.map(name => ({
    url: `${BASE_URL}${name}${EXAM_EXT}`,
    file: name
  }));

 // ===== שלב בחינה סופי (26 סרטים) =====
const FINAL_EXAM_FILES_IN_ORDER = [
  '66_4.9',
  '25_4.4',
  '65_1.4',
  '22_9.2',
  '55_6.3',
  '27_8.6',
  '22_9.8',
  '27_8.4',
  '16_4.8',
  '66_5.7',
  '32_2.0',
  '65_8.1',
  '65_2.4',
  '74_7.6',
  '35_1.6',
  '70_2.0',
  '70_1.4',
  '67_4.8',
  '74_8.4',
  '50_1.6',
  '70_4.4',
  '16_5.9',
  '32_1.2',
  '77_9.6',
  '70_4.3',
  '72_4.4'
];


  const FINAL_EXAM_VIDEOS = FINAL_EXAM_FILES_IN_ORDER.map(name => ({
    url: `${BASE_URL}${name}${EXAM_EXT}`,
    file: name
  }));

  const MAX_SECONDS_PER_VIDEO = 10;

  // ===== DOM =====
  const coverScreen           = document.getElementById('coverScreen');
  const instructionsScreen    = document.getElementById('instructionsScreen');
  const introChoiceScreen     = document.getElementById('introChoiceScreen');
  const postIntroCheckScreen  = document.getElementById('postIntroCheckScreen');
  const postIntroBreakScreen  = document.getElementById('postIntroBreakScreen');
  const mainCard              = document.getElementById('mainCard');

  const participantCover      = document.getElementById('participantCover');
  const startFromCoverBtn     = document.getElementById('startFromCoverBtn');
  const pidMsg                = document.getElementById('pidMsg');

  const continueFromInstructionsBtn = document.getElementById('continueFromInstructionsBtn');

  const startIntroBtn1        = document.getElementById('startIntroBtn1');
  const startIntroBtn2        = document.getElementById('startIntroBtn2');

  const introWatchedYesBtn    = document.getElementById('introWatchedYesBtn');
  const introWatchedNoBtn     = document.getElementById('introWatchedNoBtn');

  const continueToFinalExamBtn = document.getElementById('continueToFinalExamBtn');

  const titleEl               = document.getElementById('title');
  const instructionsTextEl    = document.getElementById('instructionsText');
  const vid                   = document.getElementById('vid');

  const ratingRange           = document.getElementById('ratingRange');
  const ratingVal             = document.getElementById('ratingVal');
  const submitBtn             = document.getElementById('submitBtn');
  const msg                   = document.getElementById('msg');

  participantCover.value = '';
  pidMsg.textContent = '';

  vid.muted = true;
  vid.volume = 0;

  let participantId = '';

  let phase = 'cover'; // 'instructions' | 'learning' | 'feedback' | 'exam' | 'introChoice' | 'intro' | 'postIntroCheck' | 'postIntroBreak' | 'finalExam'
  let learnIndex = 0;
  let feedbackIndex = 0;
  let examIndex = 0;
  let finalExamIndex = 0;

  let videoCompleted = false;
  let feedbackReveal = false;
  let vasChanged = false;

  let cutoffSeconds = MAX_SECONDS_PER_VIDEO;
  let cutoffArmed = false;

  function disarmCutoff(){ cutoffArmed = false; }

  // ✅ חשוב: המצגת (phase === 'intro') רצה עד הסוף — בלי cutoff של 10 שניות
  function armCutoff(){
    if (phase === 'intro') {
      cutoffArmed = false;
      return;
    }
    const dur = Number(vid.duration);
    cutoffSeconds = (Number.isFinite(dur) && dur > 0) ? Math.min(MAX_SECONDS_PER_VIDEO, dur) : MAX_SECONDS_PER_VIDEO;
    cutoffArmed = true;
  }

  function forceEndAtCutoff(){
    if (!cutoffArmed) return;
    if (vid.currentTime >= cutoffSeconds - 0.03) {
      cutoffArmed = false;
      try { vid.pause(); } catch(e){}
      try { vid.currentTime = cutoffSeconds; } catch(e){}
      handleVideoEnd('cutoff');
    }
  }

  function showOnly(screen){
    coverScreen.style.display          = (screen === 'cover') ? '' : 'none';
    instructionsScreen.style.display   = (screen === 'instructions') ? '' : 'none';
    introChoiceScreen.style.display    = (screen === 'introChoice') ? '' : 'none';
    postIntroCheckScreen.style.display = (screen === 'postIntroCheck') ? '' : 'none';
    postIntroBreakScreen.style.display = (screen === 'postIntroBreak') ? '' : 'none';
    mainCard.style.display             = (screen === 'main') ? '' : 'none';
  }

  function setRating(val){
    const v = Math.min(10, Math.max(0, Number(val)));
    ratingRange.value = v.toFixed(1);
    ratingVal.textContent = v.toFixed(1);
    let color;
    if (v <= 3.333) color = '#e74c3c';
    else if (v <= 6.666) color = '#f4c430';
    else color = '#2ecc71';
    ratingVal.style.color = color;
  }

  function resetStepUI(){
    videoCompleted = false;
    submitBtn.disabled = true;
    msg.innerHTML = '';
    feedbackReveal = false;
    vasChanged = false;
    disarmCutoff();
  }

  function setTitles(){
    if (phase === 'learning') titleEl.textContent = `סרטון למידה ${learnIndex+1} מתוך ${LEARNING_VIDEOS.length}`;
    if (phase === 'feedback') titleEl.textContent = `אימון עם משוב ${feedbackIndex+1} מתוך ${FEEDBACK_VIDEOS.length}`;
    if (phase === 'exam') titleEl.textContent = `שלב בחינה ${examIndex+1} מתוך ${EXAM_VIDEOS.length}`;
    if (phase === 'intro') titleEl.textContent = `מצגת`;
    if (phase === 'finalExam') titleEl.textContent = `שלב בחינה סופי ${finalExamIndex+1} מתוך ${FINAL_EXAM_VIDEOS.length}`;
  }

  function setInstructionText(){
    if (!instructionsTextEl) return;

    if (phase === 'learning') {
      instructionsTextEl.textContent = LEARNING_TEXT;
    } else if (phase === 'feedback') {
      instructionsTextEl.textContent = FEEDBACK_TEXT;
    } else if (phase === 'exam' || phase === 'finalExam') {
      instructionsTextEl.textContent = EXAM_TEXT;
    } else {
      instructionsTextEl.textContent = '';
    }
  }

  function loadCurrentVideo(){
    resetStepUI();
    showOnly('main');
    setTitles();
    setInstructionText();

    vid.muted = true;
    vid.volume = 0;

    if (phase === 'learning') {
      const vobj = LEARNING_VIDEOS[learnIndex];
      vid.src = vobj.url;

      ratingRange.disabled = true;
      submitBtn.textContent = 'המשך';
      setRating(vobj.score);

    } else if (phase === 'feedback') {
      const vobj = FEEDBACK_VIDEOS[feedbackIndex];
      vid.src = vobj.url;

      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'המשך';

    } else if (phase === 'exam') {
      const vobj = EXAM_VIDEOS[examIndex];
      vid.src = vobj.url;

      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'שליחת ציון והמשך';

    } else if (phase === 'finalExam') {
      const vobj = FINAL_EXAM_VIDEOS[finalExamIndex];
      vid.src = vobj.url;

      ratingRange.disabled = false;
      setRating(5.0);
      submitBtn.textContent = 'שליחת ציון והמשך';

    } else if (phase === 'intro') {
      ratingRange.disabled = true;
      submitBtn.disabled = true;
      submitBtn.textContent = 'המשך';
    }
  }

  ['input','change'].forEach(ev => {
    ratingRange.addEventListener(ev, () => {
      if (phase === 'feedback' || phase === 'exam' || phase === 'finalExam') {
        setRating(ratingRange.value);
      }
      if (phase === 'feedback' && !vasChanged) {
        vasChanged = true;
        if (videoCompleted && !feedbackReveal) submitBtn.disabled = false;
      }
    });
  });

  startFromCoverBtn.addEventListener('click', () => {
    const v = (participantCover.value || '').trim();
    if (!v) {
      pidMsg.textContent = 'נא להזין מספר נבדק';
      return;
    }
    participantId = v;
    pidMsg.textContent = 'נשמר ✔';

    phase = 'instructions';
    showOnly('instructions');
  });

  continueFromInstructionsBtn.addEventListener('click', () => {
    if (!participantId) return;

    phase = 'learning';
    learnIndex = 0;
    loadCurrentVideo();
  });

  // ✅ מעבר מהשקופית אחרי המצגת לשלב בחינה סופי
  continueToFinalExamBtn.addEventListener('click', () => {
    if (!participantId) return;

    phase = 'finalExam';
    finalExamIndex = 0;
    loadCurrentVideo();
  });

  // ✅ אחרי המצגת: "כן" -> מסך הפסקה, "לא" -> חזרה לבחירת מצגת
  introWatchedYesBtn.addEventListener('click', () => {
    if (!participantId) return;
    phase = 'postIntroBreak';
    showOnly('postIntroBreak');
  });

  introWatchedNoBtn.addEventListener('click', () => {
    if (!participantId) return;
    showOnly('introChoice'); // מציג שוב שני כפתורי המצגת
  });

  vid.addEventListener('click', async () => {
    if (!participantId) return;

    vid.muted = true;
    vid.volume = 0;

    try { vid.currentTime = 0; } catch(e){}

    try { await vid.play(); }
    catch(e) { try { vid.play().catch(() => {}); } catch(_) {} }
  });

  function handleVideoEnd(source){
    if (videoCompleted) return;
    videoCompleted = true;

    if (phase === 'intro') {
      if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      }
      phase = 'postIntroCheck';
      showOnly('postIntroCheck');
      return;
    }

    if (phase === 'feedback') {
      if (vasChanged && !feedbackReveal) submitBtn.disabled = false;
    } else {
      submitBtn.disabled = false;
    }
  }

  vid.addEventListener('ended', () => {
    disarmCutoff();
    handleVideoEnd('natural');
  });

  vid.addEventListener('loadedmetadata', () => {
    vid.muted = true;
    vid.volume = 0;
    armCutoff();
  });

  vid.addEventListener('timeupdate', () => { forceEndAtCutoff(); });

  function startIntroWithVideo(introUrl) {
    if (!participantId) return;

    phase = 'intro';
    showOnly('main');
    resetStepUI();
    setTitles();
    setInstructionText();

    ratingRange.disabled = true;
    submitBtn.disabled = true;

    vid.src = introUrl;
    vid.muted = true;
    vid.volume = 0;

    try { vid.preload = 'auto'; } catch(e){}
    try { vid.currentTime = 0; } catch(e){}

    const p = vid.play();
    if (p && p.catch) p.catch(() => {});

    if (vid.requestFullscreen) vid.requestFullscreen().catch(()=>{});
    else if (vid.webkitRequestFullscreen) vid.webkitRequestFullscreen();
    else if (vid.msRequestFullscreen) vid.msRequestFullscreen();
  }

  startIntroBtn1.addEventListener('click', () => startIntroWithVideo(INTRO_VIDEO_1));
  startIntroBtn2.addEventListener('click', () => startIntroWithVideo(INTRO_VIDEO_2));

  submitBtn.addEventListener('click', async () => {
    if (!videoCompleted) return;
    if (!participantId) return;

    if (phase === 'learning') {
      submitBtn.disabled = true;

      if (learnIndex < LEARNING_VIDEOS.length - 1) {
        learnIndex++;
        loadCurrentVideo();
      } else {
        phase = 'feedback';
        feedbackIndex = 0;
        loadCurrentVideo();
      }
      return;
    }

    if (phase === 'feedback') {
      const vobj = FEEDBACK_VIDEOS[feedbackIndex];

      if (!feedbackReveal) {
        submitBtn.disabled = true;

        const payload = {
          participant_id: participantId,
          video_url: vobj.url,
          rating: Number(ratingRange.value),
          user_agent: navigator.userAgent.slice(0, 500),
          meta: {
            pageHref: location.href,
            video_index: feedbackIndex + 1,
            phase: 'feedback',
            true_score: vobj.score,
            endedOnce: true,
            end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
          }
        };

        await sheetInsert(payload);

        ratingRange.disabled = true;
        feedbackReveal = true;

        msg.innerHTML =
          `<div style="font-size:2rem;font-weight:700;margin-top:10px;">
             ⭐ הציון האמיתי של סרטון זה הוא: ${vobj.score.toFixed(1)}
           </div>`;

        submitBtn.textContent =
          (feedbackIndex < FEEDBACK_VIDEOS.length - 1)
            ? 'המשך לסרטון הבא'
            : 'המשך לשלב הבחינה';

        submitBtn.disabled = false;
        return;
      }

      submitBtn.disabled = true;
      msg.innerHTML = '';
      ratingRange.disabled = false;
      submitBtn.textContent = 'המשך';

      if (feedbackIndex < FEEDBACK_VIDEOS.length - 1) {
        feedbackIndex++;
        loadCurrentVideo();
      } else {
        phase = 'exam';
        examIndex = 0;
        loadCurrentVideo();
      }
      return;
    }

    if (phase === 'exam') {
      submitBtn.disabled = true;

      const vobj = EXAM_VIDEOS[examIndex];

      const payload = {
        participant_id: participantId,
        video_url: vobj.url,
        rating: Number(ratingRange.value),
        user_agent: navigator.userAgent.slice(0, 500),
        meta: {
          pageHref: location.href,
          video_index: examIndex + 1,
          phase: 'exam',
          file_name: vobj.file,
          endedOnce: true,
          end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
        }
      };

      await sheetInsert(payload);

      if (examIndex < EXAM_VIDEOS.length - 1) {
        examIndex++;
        loadCurrentVideo();
      } else {
        showOnly('introChoice');
      }
      return;
    }

    // ✅ שלב בחינה סופי
    if (phase === 'finalExam') {
      submitBtn.disabled = true;

      const vobj = FINAL_EXAM_VIDEOS[finalExamIndex];

      const payload = {
        participant_id: participantId,
        video_url: vobj.url,
        rating: Number(ratingRange.value),
        user_agent: navigator.userAgent.slice(0, 500),
        meta: {
          pageHref: location.href,
          video_index: finalExamIndex + 1,
          phase: 'finalExam',
          file_name: vobj.file,
          endedOnce: true,
          end_rule: (cutoffSeconds < MAX_SECONDS_PER_VIDEO) ? 'natural(shorter_than_10s)' : 'max_10s'
        }
      };

      await sheetInsert(payload);

      if (finalExamIndex < FINAL_EXAM_VIDEOS.length - 1) {
        finalExamIndex++;
        loadCurrentVideo();
      } else {
        submitBtn.disabled = true;
        ratingRange.disabled = true;
        msg.textContent = 'תודה רבה על השתתפותך!.';
      }
      return;
    }
  });

  setRating(5.0);
  showOnly('cover');
});
</script>
</body>
</html>
