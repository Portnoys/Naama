<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== Supabase =====
    const SUPABASE_URL = 'https://dbintxdkurajdgimcdeb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaW50eGRrdXJhamRnaW1jZGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc1NTAsImV4cCI6MjA3NDEwMzU1MH0.usRUg5lTw96BaEydMV9wl8vtuZ3-e0MZA1UUMgh5YaA';
    const RATINGS_TABLE = 'ratings';

    // ===== ×©× ×™ ×”×¡×¨×˜×•× ×™× =====
    const VIDEO_URLS = [
      'https://portnoys.github.io/Naama/test.mp4',   // ×¡×¨×˜×•×Ÿ 1
      'https://portnoys.github.io/Naama/test2.mp4'   // ×¡×¨×˜×•×Ÿ 2
    ];

    // ===== DOM =====
    const titleEl = document.getElementById('title');
    const videoLabel = document.getElementById('videoLabel');
    const pidBlock = document.getElementById('pidBlock');
    const participantInput = document.getElementById('participant');
    const confirmPidBtn = document.getElementById('confirmPidBtn');
    const vid = document.getElementById('vid');
    const ratingRange = document.getElementById('ratingRange');
    const ratingNumber = document.getElementById('ratingNumber');
    const ratingVal = document.getElementById('ratingVal');
    const submitBtn = document.getElementById('submitBtn');
    const msg = document.getElementById('msg');

    // ××–×”×” × ×‘×“×§: × ×˜×¢×Ÿ ×× ×§×™×™×, ××‘×œ ×ª××™×“ ×“×•×¨×©×™× ××™×©×•×¨ ×‘×¡×¨×˜×•×Ÿ 1 ×›×“×™ ×œ××¤×©×¨ ×©×™× ×•×™
    const params = new URLSearchParams(location.search);
    let participantId = sessionStorage.getItem('participant_id') || params.get('pid') || '';
    participantInput.value = participantId; // ××™×œ×•×™ ××•×˜×•××˜×™ ×× ×§×™×™×
    let currentIndex = 0;
    let videoCompleted = false;

    function loadVideo(i) {
      const url = VIDEO_URLS[i];
      titleEl.textContent = i === 0 ? '×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ 1' : '×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ 2';
      try { videoLabel.textContent = new URL(url).pathname.split('/').pop(); } catch { videoLabel.textContent = url; }
      vid.src = url;
      videoCompleted = false;
      submitBtn.disabled = true;

      // ğŸ”¹ ×‘×¡×¨×˜×•×Ÿ 1 ×ª××™×“ ××‘×§×©×™× ×œ××©×¨ ××¡×¤×¨ × ×‘×“×§ (××¤×©×¨ ×œ×©× ×•×ª), ×•×—×•×¡××™× × ×™×’×•×Ÿ ×¢×“ ××–
      if (i === 0) {
        pidBlock.style.display = '';   // ××¦×™×’×™×
        vid.controls = false;          // ×—×•×¡××™× × ×™×’×•×Ÿ ×¢×“ ×œ××™×©×•×¨
      } else {
        pidBlock.style.display = 'none';
        vid.controls = true;
      }
    }

    // ××™×©×•×¨/×©×™× ×•×™ ××¡×¤×¨ × ×‘×“×§ ×œ×¤× ×™ ×¡×¨×˜×•×Ÿ 1 (×ª××™×“ × ×“×¨×©)
    confirmPidBtn.addEventListener('click', () => {
      const v = (participantInput.value || '').trim();
      if (!v) {
        msg.innerHTML = '<div class="error">× × ×œ×”×–×™×Ÿ ××¡×¤×¨ × ×‘×“×§.</div>';
        return;
      }
      participantId = v;
      sessionStorage.setItem('participant_id', participantId);
      pidBlock.style.display = 'none';
      vid.controls = true;    // ××¤×©×¨ ×œ× ×’×Ÿ ×¢×›×©×™×•
      msg.innerHTML = '';
    });

    // VAS: ×¡× ×›×¨×•×Ÿ
    function setRating(val) {
      const v = Math.min(10, Math.max(0, Number(val)));
      ratingRange.value = v.toFixed(1);
      ratingNumber.value = v.toFixed(1);
      ratingVal.textContent = v.toFixed(1);
    }
    ratingRange.addEventListener('input', () => setRating(ratingRange.value));
    ratingNumber.addEventListener('input', () => setRating(ratingNumber.value));
    setRating(5.0);

    vid.addEventListener('error', () => {
      msg.innerHTML = '<div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×•×•×™×“××•. ×‘×“×§×™ ×©×”×§×™×©×•×¨ × ×›×•×Ÿ ×•×©×–×” MP4 ×ª×§×™×Ÿ.</div>';
    });
    vid.addEventListener('ended', () => { videoCompleted = true; submitBtn.disabled = false; });

    async function supabaseInsert(row) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${RATINGS_TABLE}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(row)
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || `×©×’×™××” ×‘×©××™×¨×” (×¡×˜×˜×•×¡ ${res.status})`);
      }
      try { return await res.json(); } catch { return true; }
    }

    submitBtn.addEventListener('click', async () => {
      if (currentIndex === 0 && !participantId) {
        msg.innerHTML = '<div class="error">× × ×œ××©×¨/×œ×”×–×™×Ÿ ××¡×¤×¨ × ×‘×“×§ ×œ×¤× ×™ ×”×ª×—×œ×ª ×”×¡×¨×˜×•×Ÿ.</div>';
        return;
      }
      if (!videoCompleted) {
        msg.innerHTML = '<div class="error">×™×© ×œ×”×©×œ×™× ×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</div>';
        return;
      }

      submitBtn.disabled = true;
      msg.textContent = '';

      const payload = {
        participant_id: participantId,
        video_url: VIDEO_URLS[currentIndex],
        rating: Number(ratingNumber.value),     // ×¢×¨×š ×¨×¦×™×£
        user_agent: navigator.userAgent.slice(0, 500),
        meta: { pageHref: location.href, video_index: currentIndex + 1, endedOnce: true }
      };

      try {
        await supabaseInsert(payload);
        if (currentIndex === 0) {
          msg.innerHTML = '<div class="success">×”×¦×™×•×Ÿ ×œ×¡×¨×˜×•×Ÿ 1 × ×©××¨. ×¢×•×‘×¨×™× ×œ×¡×¨×˜×•×Ÿ 2â€¦</div>';
          setRating(5.0);
          currentIndex = 1;
          loadVideo(currentIndex);
          vid.play().catch(()=>{});
        } else {
          msg.innerHTML = '<div class="success">×”×¦×™×•×Ÿ ×œ×¡×¨×˜×•×Ÿ 2 × ×©××¨. ×ª×•×“×” ×¨×‘×”! ×¡×™×™××ª ××ª ×”× ×™×¡×•×™.</div>';
          submitBtn.disabled = true;
        }
      } catch (e) {
        msg.innerHTML = `<div class="error">${e.message}</div>`;
        submitBtn.disabled = false;
      }
    });

    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
    loadVideo(currentIndex);
  });
</script>
