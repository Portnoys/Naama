<script>
  // === מפתחות Supabase ===
  const SUPABASE_URL = 'https://dbintxdkurajdgimcdeb.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaW50eGRrdXJhamRnaW1jZGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc1NTAsImV4cCI6MjA3NDEwMzU1MH0.usRUg5lTw96BaEydMV9wl8vtuZ3-e0MZA1UUMgh5YaA';
  const RATINGS_TABLE = 'ratings';

  // וידאו קבוע שמוטמע בעמוד
  const videoUrl = "https://portnoys.github.io/Naama/test.mp4";

  // אם תרצי לאפשר pid מה-URL, השאירי את שתי השורות הבאות;
  // אם לא — החליפי לשורה: const initialPid = '';
  const params = new URLSearchParams(location.search);
  const initialPid = params.get('pid') || '';

  const vid = document.getElementById('vid');
  const participantInput = document.getElementById('participant');
  const rating = document.getElementById('rating');
  const ratingVal = document.getElementById('ratingVal');
  const submitBtn = document.getElementById('submitBtn');
  const msg = document.getElementById('msg');
  const videoLabel = document.getElementById('videoLabel');

  // מאחר שיש לנו videoUrl קבוע, פשוט נטען אותו
  vid.src = videoUrl;
  try { videoLabel.textContent = new URL(videoUrl).pathname.split('/').pop(); } catch { videoLabel.textContent = videoUrl; }

  participantInput.value = initialPid;

  rating.addEventListener('input', () => {
    ratingVal.textContent = rating.value;
  });

  // חסימת דילוג קדימה בסיסית (לא חובה)
  let lastTime = 0;
  vid.addEventListener('timeupdate', () => {
    if (vid.currentTime > lastTime + 5) {
      vid.currentTime = lastTime;
    } else {
      lastTime = vid.currentTime;
    }
  });

  let videoCompleted = false;
  vid.addEventListener('ended', () => {
    videoCompleted = true;
    submitBtn.disabled = false;
  });

  async function supabaseInsert(row) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${RATINGS_TABLE}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify(row)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'שגיאה בשמירה ל-Supabase');
    }
    return res.json();
  }

  submitBtn.addEventListener('click', async () => {
    if (!videoCompleted) {
      msg.innerHTML = '<div class="error">יש להשלים צפייה בסרטון לפני שליחה.</div>';
      return;
    }
    submitBtn.disabled = true;
    msg.textContent = '';

    try {
      const payload = {
        participant_id: participantInput.value.trim() || null,
        video_url: videoUrl,
        rating: parseInt(rating.value, 10),
        user_agent: navigator.userAgent.slice(0, 500),
        meta: { pageHref: location.href, endedOnce: true }
      };
      await supabaseInsert(payload);
      msg.innerHTML = '<div class="success">הציון נשמר. תודה רבה!</div>';
    } catch (e) {
      msg.innerHTML = `<div class="error">${e.message}</div>`;
      submitBtn.disabled = false;
    }
  });
</script>
