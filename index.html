<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== Supabase =====
    const SUPABASE_URL = 'https://dbintxdkurajdgimcdeb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaW50eGRrdXJhamRnaW1jZGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc1NTAsImV4cCI6MjA3NDEwMzU1MH0.usRUg5lTw96BaEydMV9wl8vtuZ3-e0MZA1UUMgh5YaA';
    const RATINGS_TABLE = 'ratings';

    // ===== שני הסרטונים =====
    const VIDEO_URLS = [
      'https://portnoys.github.io/Naama/test.mp4',   // סרטון 1
      'https://portnoys.github.io/Naama/test2.mp4'   // סרטון 2
    ];

    // ===== DOM =====
    const titleEl = document.getElementById('title');
    const videoLabel = document.getElementById('videoLabel');
    const pidBlock = document.getElementById('pidBlock');
    const participantInput = document.getElementById('participant');
    const confirmPidBtn = document.getElementById('confirmPidBtn');
    const vid = document.getElementById('vid');
    const ratingRange = document.getElementById('ratingRange');
    const ratingNumber = document.getElementById('ratingNumber');
    const ratingVal = document.getElementById('ratingVal');
    const submitBtn = document.getElementById('submitBtn');
    const msg = document.getElementById('msg');

    // מזהה נבדק: נטען אם קיים, אבל תמיד דורשים אישור בסרטון 1 כדי לאפשר שינוי
    const params = new URLSearchParams(location.search);
    let participantId = sessionStorage.getItem('participant_id') || params.get('pid') || '';
    participantInput.value = participantId; // מילוי אוטומטי אם קיים
    let currentIndex = 0;
    let videoCompleted = false;

    function loadVideo(i) {
      const url = VIDEO_URLS[i];
      titleEl.textContent = i === 0 ? 'צפייה בסרטון 1' : 'צפייה בסרטון 2';
      try { videoLabel.textContent = new URL(url).pathname.split('/').pop(); } catch { videoLabel.textContent = url; }
      vid.src = url;
      videoCompleted = false;
      submitBtn.disabled = true;

      // 🔹 בסרטון 1 תמיד מבקשים לאשר מספר נבדק (אפשר לשנות), וחוסמים ניגון עד אז
      if (i === 0) {
        pidBlock.style.display = '';   // מציגים
        vid.controls = false;          // חוסמים ניגון עד לאישור
      } else {
        pidBlock.style.display = 'none';
        vid.controls = true;
      }
    }

    // אישור/שינוי מספר נבדק לפני סרטון 1 (תמיד נדרש)
    confirmPidBtn.addEventListener('click', () => {
      const v = (participantInput.value || '').trim();
      if (!v) {
        msg.innerHTML = '<div class="error">נא להזין מספר נבדק.</div>';
        return;
      }
      participantId = v;
      sessionStorage.setItem('participant_id', participantId);
      pidBlock.style.display = 'none';
      vid.controls = true;    // אפשר לנגן עכשיו
      msg.innerHTML = '';
    });

    // VAS: סנכרון
    function setRating(val) {
      const v = Math.min(10, Math.max(0, Number(val)));
      ratingRange.value = v.toFixed(1);
      ratingNumber.value = v.toFixed(1);
      ratingVal.textContent = v.toFixed(1);
    }
    ratingRange.addEventListener('input', () => setRating(ratingRange.value));
    ratingNumber.addEventListener('input', () => setRating(ratingNumber.value));
    setRating(5.0);

    vid.addEventListener('error', () => {
      msg.innerHTML = '<div class="error">שגיאה בטעינת הווידאו. בדקי שהקישור נכון ושזה MP4 תקין.</div>';
    });
    vid.addEventListener('ended', () => { videoCompleted = true; submitBtn.disabled = false; });

    async function supabaseInsert(row) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${RATINGS_TABLE}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(row)
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || `שגיאה בשמירה (סטטוס ${res.status})`);
      }
      try { return await res.json(); } catch { return true; }
    }

    submitBtn.addEventListener('click', async () => {
      if (currentIndex === 0 && !participantId) {
        msg.innerHTML = '<div class="error">נא לאשר/להזין מספר נבדק לפני התחלת הסרטון.</div>';
        return;
      }
      if (!videoCompleted) {
        msg.innerHTML = '<div class="error">יש להשלים צפייה בסרטון לפני שליחה.</div>';
        return;
      }

      submitBtn.disabled = true;
      msg.textContent = '';

      const payload = {
        participant_id: participantId,
        video_url: VIDEO_URLS[currentIndex],
        rating: Number(ratingNumber.value),     // ערך רציף
        user_agent: navigator.userAgent.slice(0, 500),
        meta: { pageHref: location.href, video_index: currentIndex + 1, endedOnce: true }
      };

      try {
        await supabaseInsert(payload);
        if (currentIndex === 0) {
          msg.innerHTML = '<div class="success">הציון לסרטון 1 נשמר. עוברים לסרטון 2…</div>';
          setRating(5.0);
          currentIndex = 1;
          loadVideo(currentIndex);
          vid.play().catch(()=>{});
        } else {
          msg.innerHTML = '<div class="success">הציון לסרטון 2 נשמר. תודה רבה! סיימת את הניסוי.</div>';
          submitBtn.disabled = true;
        }
      } catch (e) {
        msg.innerHTML = `<div class="error">${e.message}</div>`;
        submitBtn.disabled = false;
      }
    });

    // הפעלה ראשונית
    loadVideo(currentIndex);
  });
</script>
